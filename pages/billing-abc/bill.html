<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>App-TechVaseegrah</title>
  <link rel="stylesheet" href="../../assets/vendors/mdi/css/materialdesignicons.min.css">
  <link rel="stylesheet" href="../../assets/vendors/css/vendor.bundle.base.css">
  <link rel="stylesheet" href="../../assets/css/style.css">
  <script src="../../assets/js/script.js"></script>
  <link rel="shortcut icon" href="../../assets/images/favicon1.ico" />
  <style>
    .page {
        text-align: center;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }

    tfoot td {
        font-weight: bold;
    }

    button {
        margin: 10px;
    }

    input[type="number"] {
        width: 60px; 
    }

    .remove-btn {
        background-color: rgb(34, 33, 33);
        color: white;
        border: none;
        cursor: pointer;
        padding: 2px 2px 2px 2px;
        border-radius: 4px;
    }
    .button1{
      width: 100%;
    }
    
    .button1 button {
    width: 16%;
    padding: 10px;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    } 
    
    button {
    width: 16%;
    padding: 10px;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight:bold;
    letter-spacing: 1px;
    } 
    button:hover{
    color: black;
    }
  </style>
</head>
<body>
<div class="container-scroller">
  <nav class="navbar default-layout-navbar col-lg-12 col-12 p-0 fixed-top d-flex flex-row">
    <div class="text-center navbar-brand-wrapper d-flex align-items-center justify-content-center">
      <a class="navbar" href="dashboard.html">
        <img src="../../assets/images/Tech Logo1.png" alt="" style="height: 70px; width: 200px;"></a>
    </div>
    <div class="navbar-menu-wrapper d-flex align-items-stretch">
      <button class="navbar-toggler navbar-toggler align-self-center" type="button" data-toggle="minimize">
        <span class="mdi mdi-menu"></span>
      </button>
      <div class="search-field d-none d-md-block">
        <form class="d-flex align-items-center h-100" action="#">
          <div class="input-group">
            <div class="input-group-prepend bg-transparent">
              <i class="input-group-text border-0 mdi mdi-magnify"></i>
            </div>
            <input type="text" class="form-control bg-transparent border-0" placeholder="Search projects">
          </div>
        </form>
      </div>
      <ul class="navbar-nav navbar-nav-right">
        <li class="nav-item nav-profile dropdown">
          <a class="nav-link dropdown-toggle" id="profileDropdown" href="#" data-bs-toggle="dropdown" aria-expanded="false">
            <div class="nav-profile-img">
              <span class="availability-status"></span>
            </div>
            <div class="nav-profile-text">
              <p class="mb-1 text-black">Leenasri</p>
            </div>
          </a>
          <div class="dropdown-menu navbar-dropdown" aria-labelledby="profileDropdown">
            <a class="dropdown-item" href="#">
              <i class="mdi mdi-cached me-2 text-success"></i> Activity Log </a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="#">
              <i class="mdi mdi-logout me-2 text-primary"></i> Signout </a>
          </div>
        </li>
        <li class="nav-item d-none d-lg-block full-screen-link">
          <a class="nav-link">
            <i class="mdi mdi-fullscreen" id="fullscreen-button"></i>
          </a>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link count-indicator dropdown-toggle" id="messageDropdown" href="#" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="mdi mdi-email-outline"></i>
            <span class="count-symbol bg-warning"></span>
          </a>
          <div class="dropdown-menu dropdown-menu-right navbar-dropdown preview-list" aria-labelledby="messageDropdown">
            <h6 class="p-3 mb-0">Messages</h6>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item preview-item">
              <div class="preview-thumbnail">
                <img src="../../assets/images/faces/face4.jpg" alt="image" class="profile-pic">
              </div>
              <div class="preview-item-content d-flex align-items-start flex-column justify-content-center">
                <h6 class="preview-subject ellipsis mb-1 font-weight-normal">Mark send you a message</h6>
                <p class="text-gray mb-0"> 1 Minutes ago </p>
              </div>
            </a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item preview-item">
              <div class="preview-thumbnail">
                <img src="../../assets/images/faces/face2.jpg" alt="image" class="profile-pic">
              </div>
              <div class="preview-item-content d-flex align-items-start flex-column justify-content-center">
                <h6 class="preview-subject ellipsis mb-1 font-weight-normal">Cregh send you a message</h6>
                <p class="text-gray mb-0"> 15 Minutes ago </p>
              </div>
            </a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item preview-item">
              <div class="preview-thumbnail">
                <img src="../../assets/images/faces/face3.jpg" alt="image" class="profile-pic">
              </div>
              <div class="preview-item-content d-flex align-items-start flex-column justify-content-center">
                <h6 class="preview-subject ellipsis mb-1 font-weight-normal">Profile picture updated</h6>
                <p class="text-gray mb-0"> 18 Minutes ago </p>
              </div>
            </a>
            <div class="dropdown-divider"></div>
            <h6 class="p-3 mb-0 text-center">4 new messages</h6>
          </div>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link count-indicator dropdown-toggle" id="notificationDropdown" href="#" data-bs-toggle="dropdown">
            <i class="mdi mdi-bell-outline"></i>
            <span class="count-symbol bg-danger"></span>
          </a>
          <div class="dropdown-menu dropdown-menu-right navbar-dropdown preview-list" aria-labelledby="notificationDropdown">
            <h6 class="p-3 mb-0">Notifications</h6>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item preview-item">
              <div class="preview-thumbnail">
                <div class="preview-icon bg-success">
                  <i class="mdi mdi-calendar"></i>
                </div>
              </div>
              <div class="preview-item-content d-flex align-items-start flex-column justify-content-center">
                <h6 class="preview-subject font-weight-normal mb-1">Event today</h6>
                <p class="text-gray ellipsis mb-0"> Just a reminder that you have an event today </p>
              </div>
            </a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item preview-item">
              <div class="preview-thumbnail">
                <div class="preview-icon bg-warning">
                  <i class="mdi mdi-settings"></i>
                </div>
              </div>
              <div class="preview-item-content d-flex align-items-start flex-column justify-content-center">
                <h6 class="preview-subject font-weight-normal mb-1">Settings</h6>
                <p class="text-gray ellipsis mb-0"> Update dashboard </p>
              </div>
            </a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item preview-item">
              <div class="preview-thumbnail">
                <div class="preview-icon bg-info">
                  <i class="mdi mdi-link-variant"></i>
                </div>
              </div>
              <div class="preview-item-content d-flex align-items-start flex-column justify-content-center">
                <h6 class="preview-subject font-weight-normal mb-1">Launch Admin</h6>
                <p class="text-gray ellipsis mb-0"> New admin wow! </p>
              </div>
            </a>
            <div class="dropdown-divider"></div>
            <h6 class="p-3 mb-0 text-center">See all notifications</h6>
          </div>
        </li>
        <li class="nav-item nav-logout d-none d-lg-block">
          <a class="nav-link" href="#">
            <i class="mdi mdi-power"></i>
          </a>
        </li>
        <li class="nav-item nav-settings d-none d-lg-block">
          <a class="nav-link" href="#">
            <i class="mdi mdi-format-line-spacing"></i>
          </a>
        </li>
      </ul>
      <button class="navbar-toggler navbar-toggler-right d-lg-none align-self-center" type="button" data-toggle="offcanvas">
        <span class="mdi mdi-menu"></span>
      </button>
    </div>
  </nav>
  <div class="container-fluid page-body-wrapper">
    <nav class="sidebar sidebar-offcanvas" id="sidebar">
      <ul class="nav">
        <li class="nav-item nav-profile">
          <a href="#" class="nav-link">
            <div class="nav-profile-image">
              <span class="login-status online"></span>
            </div>
            <div class="nav-profile-text d-flex flex-column">
              <span class="font-weight-bold mb-2">Leenasri</span>
            </div>
            <i class="mdi mdi-bookmark-check text-success nav-profile-badge"></i>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../../index.html">
            <span class="menu-title">Dashboard</span>
            <i class="mdi mdi-home menu-icon"></i>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../../pages/printing-abc/print.html">
            <span class="menu-title">Printing</span>
            <i class="mdi mdi-printer menu-icon"></i>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../../pages/packing-abc/pack.html">
            <span class="menu-title">Packing</span>
            <i class="mdi mdi-package-variant-closed menu-icon"></i>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../../pages/tracking-abc/track.html">
            <span class="menu-title">Tracking</span>
            <i class="mdi mdi-truck menu-icon"></i>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../../pages/holding-abc/hold.html">
            <span class="menu-title">Holding</span>
            <i class="mdi mdi-package-variant menu-icon"></i>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../../pages/billing-abc/bill.html">
            <span class="menu-title">Billing</span>
            <i class="mdi mdi-calendar-edit menu-icon"></i>
          </a>
        </li>
      </ul>
    </nav>
    <div class="main-panel">
      <div class="content-wrapper">
        <div class="page-header">
          <h3 class="page-title"> Billing </h3>
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
              <li class="breadcrumb-item active" aria-current="page"></li>
            </ol>
          </nav>
        </div>
        <div class="row">
          <div class="col-12 grid-margin stretch-card">
            <div class="card">
              <div class="card bg-gradient-primary card-img-holder text-white">
                <div class="card-body">
                  <div id="billing-page" class="page">
                    <label for="customerName"></label>
                    <input type="text" id="customerName" class="form-control-lg" style="border: 1px solid gainsboro;text-align: center;" placeholder="Enter The Name"> <br><br>
                    <label for="phoneNumber"></label>
                    <input type="text" id="phoneNumber" class="form-control-lg" style="border: 1px solid gainsboro;text-align: center;" placeholder="Enter Phone Number" maxlength="10"> <br><br>
                    <label for="productSku"></label>
                    <input type="text" id="productSku" class="form-control-lg" style="border: 1px solid gainsboro;text-align: center;" placeholder="Enter Product SKU"> <br> <br>
                    <div class="button1"><button class="btn bg-gradient-danger" onclick="addProductToBilling()">Add Product</button></div>
                    <table id="billingTable">
                      <thead>
                        <tr>
                          <th>Product Name</th>
                          <th>Quantity</th>
                          <th>Price</th>
                          <th>Total Price</th>
                          <th>Remove</th>
                        </tr>
                      </thead>
                      <tbody></tbody>
                      <tfoot>
                        <tr>
                          <td colspan="3">Total</td>
                          <td id="total">Rs.0.00</td>
                          <td></td>
                        </tr>
                        <tr>
                          <td colspan="3">Total Quantity</td>
                          <td id="totalQuantity">0</td>
                          <td></td>
                        </tr>
                      </tfoot>
                    </table> <br>
                    <label for="paymentMethod" style="font-size: large;">Payment Method:</label>
                    <select class="form-control-sm" id="paymentMethod">
                      <option value="cash">Cash</option>
                      <option value="online">Online</option>
                    </select>
                    <br><br>
                    <label for="amountPaid"></label>
                    <input type="tel" id="amountPaid" class="form-control-lg" style="border: 1px solid gainsboro;text-align: center;" placeholder="Amount Paid By Customer">
                    <br><br>
                    <div class="button1"><button class="btn bg-gradient-danger" onclick="generateBill()">Print Bill</button></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <script>
        const billingTableBody = document.querySelector('#billingTable tbody');
        const totalElement = document.getElementById('total');
        const totalQuantityElement = document.getElementById('totalQuantity');
        let nextBillNumber = localStorage.getItem('nextBillNumber') || 1000;
        const productQuantities = new Map();
        let total = 0;
        
        document.querySelectorAll('#billing-page input').forEach(input => {
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
        
                    const form = document.getElementById('billing-page');
                    const inputs = form.getElementsByTagName('input');
                    let index = -1;
        
                    for (let i = 0; i < inputs.length; i++) {
                        if (inputs[i] === input) {
                            index = i;
                            break;
                        }
                    }
        
                    if (index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }
                }
            });
        });
        
        const fetchProductDetails = async (sku) => {
            try {
                const response = await fetch(`/product-details/${sku}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch product details from the server');
                }
                return await response.json();
            } catch (error) {
                console.error(error.message);
                return null;
            }
        };
        
        async function addProductToBilling() {
            const productSku = document.getElementById('productSku').value;
        
            const productDetails = await fetchProductDetails(productSku);
            if (productDetails) {
                const { productName, price } = productDetails;
        
                const row = billingTableBody.insertRow();
                const productNameCell = row.insertCell();
                productNameCell.textContent = productName;
        
                const quantityCell = row.insertCell();
                const quantityInput = document.createElement('input');
                quantityInput.type = 'number';
                quantityInput.value = 1;
                quantityInput.min = 1;
                quantityInput.onchange = updateTotalPrice.bind(null, row, price);
                quantityCell.appendChild(quantityInput);
        
                const priceCell = row.insertCell();
                priceCell.textContent = `Rs.${price.toFixed(2)}`;
        
                const totalPriceCell = row.insertCell();
                totalPriceCell.textContent = `Rs.${price.toFixed(2)}`;
        
                const removeCell = row.insertCell();
                const removeButton = document.createElement('button');
                removeButton.textContent = 'X';
                removeButton.classList.add('remove-btn');
                removeButton.onclick = function() {
                    removeProduct(row, price, parseInt(quantityInput.value));
                };
                removeCell.appendChild(removeButton);
        
                total += price;
                totalElement.textContent = `Rs.${total.toFixed(2)}`;
        
                document.getElementById('productSku').value = '';
        
                updateTotalQuantity();
            } else {
                alert('Failed to fetch product details. Please check the SKU and try again.');
            }
        }
        
        function updateTotalPrice(row, price) {
            const quantityInput = row.cells[1].querySelector('input');
            const quantity = parseInt(quantityInput.value);
            const totalPrice = price * quantity;
            row.cells[3].textContent = `Rs.${totalPrice.toFixed(2)}`;
        
            calculateTotal();
            updateTotalQuantity();
        }
        
        function calculateTotal() {
            total = 0;
            for (let i = 0; i < billingTableBody.rows.length; i++) {
                const totalPriceCell = billingTableBody.rows[i].cells[3];
                const totalPrice = parseFloat(totalPriceCell.textContent.replace('Rs.', ''));
                total += totalPrice;
            }
            totalElement.textContent = `Rs.${total.toFixed(2)}`;
        }
        
        function updateTotalQuantity() {
            let totalQuantity = 0;
            for (let i = 0; i < billingTableBody.rows.length; i++) {
                const quantityInput = billingTableBody.rows[i].cells[1].querySelector('input');
                totalQuantity += parseInt(quantityInput.value);
            }
            totalQuantityElement.textContent = totalQuantity;
        }
        
        function removeProduct(row, price, quantity) {
            total -= price * quantity;
            totalElement.textContent = `Rs.${total.toFixed(2)}`;
        
            billingTableBody.removeChild(row);
        
            updateTotalQuantity();
        }
        
        function generateBill() {
            const billNumber = nextBillNumber;
            nextBillNumber++;
        
            const currentDate = new Date();
            const formattedDate = `${currentDate.getDate()}/${currentDate.getMonth() + 1}/${currentDate.getFullYear()}`;
        
            let totalQuantity = 0;
            for (let i = 0; i < billingTableBody.rows.length; i++) {
                const quantityInput = billingTableBody.rows[i].cells[1].querySelector('input');
                totalQuantity += parseInt(quantityInput.value);
            }
        
            const customerName = document.getElementById('customerName').value;
            const phoneNumber = document.getElementById('phoneNumber').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const amountPaid = parseFloat(document.getElementById('amountPaid').value);
            const balance = amountPaid - total;
            const formattedTotalPrice = `Rs.${total.toFixed(2)}`;
        
            let billingTableBodyHTML = '';
            for (let i = 0; i < billingTableBody.rows.length; i++) {
                const row = billingTableBody.rows[i];
                const productName = row.cells[0].textContent;
                const quantity = row.cells[1].querySelector('input').value;
                const price = row.cells[2].textContent;
                const totalPrice = row.cells[3].textContent;
        
                billingTableBodyHTML += `
                    <tr>
                        <td>${productName}</td>
                        <td>${quantity}</td>
                        <td>${price}</td>
                        <td>${totalPrice}</td>
                    </tr>
                `;
            }
        
            const billContent = `
                <html>
                    <head>
                        <title>Billing Invoice</title>
                        <h2 class="text-center">ðŸŒºVaseegrah VedaðŸŒ¿</h2>
                        <h6 class="text-center address">No:7 VIJAYA NAGAR,<br>
                        SRINIVASAPURAM(Po)<br>
                        THANJAVUR<br>
                        TAMIL NADU-613009<br>
                        MOBILE:9786424450</h6>
                        <h4 class="text-center">www.vaseegrahveda.com</h4>
                        <h5 class="text-center">Bill No: ${billNumber}</h5>
                        <style>
                            body {
                                font-family: Arial, sans-serif;
                                margin: 0;
                                padding: 0;
                            }
                            .container {
                                max-width: 800px;
                                margin: 0 auto;
                                padding: 20px;
                            }
                            h2 {
                                text-align: center;
                                margin-bottom: 20px;
                            }
                            h5 {
                                margin-top: 10px;
                                margin-bottom: 5px;
                            }
                            table {
                                width: 100%;
                                border-collapse: collapse;
                                margin-bottom: 20px;
                            }
                            th, td {
                                border: 1px solid #ddd;
                                padding: 8px;
                                text-align: left;
                            }
                            tfoot td {
                                font-weight: bold;
                            }
                            .text-center {
                                text-align: center;
                            }
                            .address{
                                position:relative;
                                top:-20px;
                            }
                            .label-container {
                                display: flex;
                                justify-content: space-between;
                                margin-bottom: 10px;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="label-container">
                            <h5>Name: ${customerName}</h5>
                            <h5>Ph No: ${phoneNumber}</h5>
                        </div>
                        <div class="label-container">
                            <h5>Payment: ${paymentMethod}</h5>
                            <h5>Date: ${formattedDate}</h5>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Product Name</th>
                                    <th>Qty</th>
                                    <th>Price</th>
                                    <th>Total Price</th>
                                </tr>
                            </thead>
                            <tbody>${billingTableBodyHTML}</tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3">Total Quantity</td>
                                    <td>${totalQuantity}</td>
                                </tr>
                                <tr>
                                    <td colspan="3">Total</td>
                                    <td>${formattedTotalPrice}</td>
                                </tr>
                            </tfoot>
                        </table>
                        <h5 class="text-center">Amount Paid: Rs.${amountPaid.toFixed(2)}</h5>
                        <h5 class="text-center">Balance: Rs.${balance.toFixed(2)}</h5>
                        <h5 class="text-center">Thanks for Coming! Visit Us Again!</h5>
                    </body>
                </html>
            `;
        
            const billWindow = window.open('', '_blank');
            billWindow.document.write(billContent);
            billWindow.print();
            billWindow.close();
        
            localStorage.setItem('nextBillNumber', nextBillNumber);
        }
      </script>
      <script src="https://unpkg.com/jspdf@latest/dist/jspdf.min.js"></script>     
    </div>
  </div>
</div>
</body>
</html>
